databases:
  - name: doan-mysql
    databaseType: mysql
    mysqlVersion: 8.0
    plan: free
    databaseName: doan
    user: doan_app
    diskSizeGB: 10
    ipAllowList: []

services:
  - type: web # <--- Đã sửa
    name: doan-laravel-app
    env: docker
    plan: starter
    dockerfilePath: ./Dockerfile
    autoDeploy: true
    healthCheckPath: /

    # --- SỬA LỖI PUSHER TẠI ĐÂY ---
    # Chuyển 'optimize' đến đây để nó chạy SAU KHI deploy
    # và có quyền truy cập vào các biến môi trường bí mật (Pusher keys)
    postDeployCommand: php artisan optimize && php artisan migrate --force
    
    envVars:
      - key: APP_ENV
        value: production
      - key: APP_DEBUG
        value: "false"
      - key: APP_KEY
        sync: false # <-- Nhớ tự thêm giá trị này trên Render
      - key: APP_URL
        sync: false # <-- Nhớ tự thêm giá trị này trên Render
      - key: LOG_LEVEL
        value: warning
      - key: DB_CONNECTION
        value: mysql
      - key: DB_HOST
        fromDatabase:
          name: doan-mysql
          property: host
      - key: DB_PORT
        fromDatabase:
          name: doan-mysql
          property: port
      - key: DB_DATABASE
        fromDatabase:
          name: doan-mysql
          property: database
      - key: DB_USERNAME
        fromDatabase:
          name: doan-mysql
          property: user
      - key: DB_PASSWORD
        fromDatabase:
          name: doan-mysql
          property: password
      - key: SESSION_DRIVER
        value: database
      - key: CACHE_STORE
        value: database
      
      # --- LƯU Ý ---
      # Bạn cũng cần thêm các biến PUSHER_... của mình vào đây
      # (hoặc vào tab Environment trên Render)
      # - key: PUSHER_APP_ID
      #   sync: false
      # - key: PUSHER_APP_KEY
      #   sync: false
      # - key: PUSHER_APP_SECRET
      #   sync: false